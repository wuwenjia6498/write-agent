# 🚀 Vercel + Railway 部署检查清单

## 📍 你的部署信息

- **Railway 后端**: `https://write-agent-production.up.railway.app`
- **Vercel 前端**: （待填写）

---

## ✅ 已修复的问题

我已经帮你修复了以下问题：

### 1. ✅ 端口配置问题
- **问题**: `main.py` 硬编码端口 8000
- **修复**: 改为读取 `$PORT` 环境变量
- **代码**: 已更新 `server/main.py`

### 2. ✅ CORS 配置问题
- **问题**: 只允许 localhost，不允许 Vercel 域名
- **修复**: 添加了动态 CORS 配置
- **代码**: 已更新 `server/main.py`

### 3. ✅ Railway 配置文件
- **添加**: `railway.toml` 配置文件
- **作用**: 指定构建和启动命令

---

## 🔧 Railway 环境变量配置

进入 Railway Dashboard → 你的项目 → Variables

**必须添加以下环境变量**：

```env
# 数据库连接（已有）
DATABASE_URL=postgresql://postgres.swdwayuvvtxczzcpmgzz:wwj13705746498@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres

# AI 服务配置（已有）
ANTHROPIC_API_KEY=sk-6YiLO3dhvduzRb0wC1906e6f05094e7696C53603B61296D9
ANTHROPIC_BASE_URL=https://aihubmix.com
ANTHROPIC_MODEL=claude-4-5-sonnet
TAVILY_API_KEY=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

# 环境标识（新增）
ENVIRONMENT=production

# 前端 URL（新增 - 用于 CORS）
FRONTEND_URL=https://你的vercel域名.vercel.app
```

⚠️ **注意**：
- 不要设置 `PORT` 变量（Railway 会自动注入）
- 不要设置 `NEXT_PUBLIC_API_URL`（这是前端变量）

---

## 🌐 Vercel 环境变量配置

进入 Vercel Dashboard → 你的项目 → Settings → Environment Variables

**必须添加以下环境变量**：

```env
# Supabase 配置（前端直连）
NEXT_PUBLIC_SUPABASE_URL=https://swdwayuvvtxczzcpmgzz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_joX1w8u7KeDqo3eVVSlsHg_A0ytPgUO

# 后端 API 地址（指向 Railway）
NEXT_PUBLIC_API_URL=https://write-agent-production.up.railway.app
```

⚠️ **配置后必须重新部署 Vercel 项目**！

---

## 🧪 测试步骤

### 步骤 1: 推送代码到 Git

修改已保存到本地，现在需要推送到 Git：

```bash
git add .
git commit -m "fix: 修复 Railway 部署配置（动态端口 + CORS）"
git push
```

### 步骤 2: 等待 Railway 自动重新部署

Railway 会检测到代码变更，自动重新部署。

查看部署状态：
1. 进入 Railway Dashboard
2. 点击你的项目
3. 查看 "Deployments" 标签
4. 等待状态变为 "Success"

### 步骤 3: 检查 Railway 日志

在部署日志中查找：

```
✅ 成功标志：
[INFO] 启动服务在端口: XXXX
INFO:     Uvicorn running on http://0.0.0.0:XXXX

❌ 失败标志：
ModuleNotFoundError
Connection refused
Database connection failed
```

### 步骤 4: 测试 Railway 后端

#### 方法 1: 浏览器测试

直接访问：
```
https://write-agent-production.up.railway.app/
```

期望返回：
```json
{
  "status": "ok",
  "message": "老约翰自动化写作AGENT API 运行中",
  "version": "1.0.0"
}
```

#### 方法 2: 使用测试脚本

```bash
cd E:\000-cursor_study\write-agent
python test_railway_deployment.py
```

按提示输入：`https://write-agent-production.up.railway.app`

### 步骤 5: 配置 Vercel 环境变量

1. 进入 Vercel Dashboard
2. Settings → Environment Variables
3. 添加 `NEXT_PUBLIC_API_URL` = `https://write-agent-production.up.railway.app`
4. 点击 "Save"

### 步骤 6: 重新部署 Vercel

有两种方法：

**方法 1: 推送代码**
```bash
git commit --allow-empty -m "redeploy"
git push
```

**方法 2: 手动触发**
1. 进入 Vercel Dashboard
2. Deployments 标签
3. 点击最新部署右侧的 "..." → "Redeploy"

### 步骤 7: 测试完整流程

1. 访问你的 Vercel 前端 URL
2. 按 F12 打开开发者工具
3. 进入 "Network" 标签
4. 刷新页面
5. 检查是否有 API 请求发送到 Railway 后端
6. 检查请求状态码是否为 200

---

## 🐛 常见问题排查

### 问题 1: Railway 返回 503

**原因**: 服务未启动或崩溃

**排查**:
1. 检查 Railway 日志是否有错误
2. 确认 `main.py` 使用了 `os.getenv("PORT")`
3. 检查所有环境变量是否配置正确

### 问题 2: Railway 返回 502

**原因**: 服务启动但无法响应

**排查**:
1. 检查数据库连接是否正常
2. 访问 `/health` 端点查看详细错误
3. 检查 Railway 日志中的错误信息

### 问题 3: 前端显示 CORS 错误

**原因**: CORS 配置不正确

**排查**:
1. 确认 Railway 环境变量中设置了 `FRONTEND_URL`
2. 确认 `FRONTEND_URL` 与实际 Vercel 域名一致
3. 重新部署 Railway

### 问题 4: 前端无法连接后端

**原因**: API URL 配置错误

**排查**:
1. 检查 Vercel 环境变量中的 `NEXT_PUBLIC_API_URL`
2. 确认 URL 正确（不要有末尾斜杠）
3. 重新部署 Vercel

### 问题 5: 数据库连接超时

**原因**: Railway 无法访问 Supabase

**排查**:
1. 检查 `DATABASE_URL` 格式是否正确
2. 确认 Supabase 允许所有 IP 访问
3. 尝试在本地使用相同的 DATABASE_URL 测试

---

## 📋 最终检查清单

部署完成后，确认以下所有项目：

### Railway 后端
- [ ] 部署状态为 "Success"
- [ ] 日志显示 "Uvicorn running"
- [ ] 访问根路径返回 JSON 状态
- [ ] 访问 `/health` 返回健康状态
- [ ] 访问 `/api/channels` 返回频道列表
- [ ] 所有环境变量已配置

### Vercel 前端
- [ ] 部署状态为 "Ready"
- [ ] 环境变量 `NEXT_PUBLIC_API_URL` 已设置
- [ ] 环境变量 `NEXT_PUBLIC_SUPABASE_URL` 已设置
- [ ] 环境变量 `NEXT_PUBLIC_SUPABASE_ANON_KEY` 已设置
- [ ] 已重新部署（环境变量修改后）

### 功能测试
- [ ] 前端可以正常访问
- [ ] 前端可以加载频道列表
- [ ] 前端可以创建任务
- [ ] Network 标签没有 CORS 错误
- [ ] Network 标签没有 404 错误

---

## 🎯 下一步

1. **立即执行**: 推送代码到 Git（触发 Railway 重新部署）
2. **测试后端**: 使用测试脚本或浏览器测试
3. **配置前端**: 在 Vercel 设置环境变量
4. **重新部署**: 触发 Vercel 重新部署
5. **验证**: 访问前端，测试完整流程

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. Railway 部署日志（最后 50 行）
2. 访问后端 URL 的截图或返回内容
3. 前端 Network 标签的截图（F12）
4. 具体的错误信息

我可以帮你精准定位问题！
